# Scenario generation and ROM repacking

During my RE efforts, I often had to make wild guesses at how things work. Honestly, I was right more often than I expected, but there were (and still are) a lot of cases where there simply was not enough data to make any useful guesses. For these cases, and out of a strong curiosity to what extent this was actually possible, I decided to investigate the possibility of creating my own rom files to be loaded, which would then eventually contain fully custom SNR files.

The first thing I noticed is that Saku's engine does not accept modified rom files at all. But for whatever reason, Kal's engine has absolutely no problem with this, which is pretty cool.

Generating rom files is pretty simple, I just had to do the exact opposite of 07th-mod's [`blabla.py`](https://github.com/07th-mod/enter_extractor/blob/master/blabla.py) script. The script to use for this is [`repack.rb`](https://gitlab.com/Neurochitin/kaleido/-/blob/saku/rom-repack/repack.rb), which is able to generate a bit-exact copy of the original rom file from the folder structure generated by blabla.py. (Although I have only tested this for Kal, it is possible that it is not bit exact for other files)

The trickier part was generating the scenario files, and especially the script sections. The way I did this is by using Ruby as a DSL. The relevant script is [`kal_real.rb`](https://gitlab.com/Neurochitin/kaleido/-/blob/saku/rom-repack/kal_real.rb), which loads a Ruby script containing a `raw_apply` method. An example of how such a script might look like can be seen in [`minimal_example.rb`](https://gitlab.com/Neurochitin/kaleido/-/blob/saku/rom-repack/minimal_example.rb), which is Kal's script reduced to its bare essentials and with some demo instructions added. Assuming the correct assets are present, this can be loaded in Kal's engine without problems.

To make modding a bit easier, I also changed the original read_scenario.rb to output a `_raw.rb` file containing Ruby code to replicate the parsed script. This transformation is not yet bit-exact because Entergram's halfwidth conversion is not bijective, but the differences are tiny and I could absolutely not be bothered to work around this at that point. I may fix this in the future.

I hope this will be of use to somebody. :)
